<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ê–≤—Ç–æ –∑ –°–®–ê</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{--bg:#0a0a0a;--card:#141414;--card2:#1c1c1c;--line:#252525;--gold:#d4a843;--red:#e05252;--blue:#5bb4ff;--text:#efefef;--text2:#777;--text3:#3a3a3a;--r:16px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Display',sans-serif;min-height:100vh;overscroll-behavior:none}
/* HEADER */
.hdr{position:sticky;top:0;z-index:50;background:rgba(10,10,10,.97);backdrop-filter:blur(24px);border-bottom:1px solid var(--line);padding:12px 16px 10px}
.hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.brand{font-size:20px;font-weight:900;letter-spacing:-1px}
.brand em{color:var(--gold);font-style:normal}
.chip{background:var(--card2);border:1px solid var(--line);color:var(--text2);font-size:12px;font-weight:700;padding:4px 12px;border-radius:20px}
.srch{position:relative;margin-bottom:12px}
.srch input{width:100%;background:var(--card2);border:1.5px solid var(--line);border-radius:12px;padding:10px 14px 10px 40px;color:var(--text);font-size:14px;outline:none;transition:border .2s}
.srch input:focus{border-color:var(--gold)}
.srch input::placeholder{color:var(--text3)}
.srch-ic{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:15px;pointer-events:none}
/* FILTERS PANEL */
.filters-panel{padding:0 16px 10px;display:flex;flex-direction:column;gap:10px}
/* SLIDER */
.slider-wrap{background:var(--card);border:1.5px solid var(--line);border-radius:12px;padding:12px 14px}
.slider-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.slider-title{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.slider-vals{font-size:13px;font-weight:800;color:var(--blue)}
.range-wrap{position:relative;height:20px;display:flex;align-items:center}
.range-track{position:absolute;left:0;right:0;height:4px;background:var(--line);border-radius:2px}
.range-fill{position:absolute;height:4px;background:var(--gold);border-radius:2px}
input[type=range]{position:absolute;width:100%;height:4px;background:none;outline:none;-webkit-appearance:none;pointer-events:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--gold);border:3px solid #000;cursor:pointer;pointer-events:all;box-shadow:0 2px 6px rgba(0,0,0,.5)}
input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--gold);border:3px solid #000;cursor:pointer;pointer-events:all}
/* SELECTS */
.sel-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sel-row.full{grid-template-columns:1fr}
.fsel{width:100%;background:var(--card2);border:1.5px solid var(--line);color:var(--text2);font-size:13px;font-weight:700;padding:9px 14px;border-radius:12px;cursor:pointer;outline:none;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23777' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
.fsel.active{border-color:var(--gold);color:var(--gold)}
/* SORT */
.sortbar{display:flex;align-items:center;gap:7px;padding:8px 16px 10px;overflow-x:auto;scrollbar-width:none}
.sortbar::-webkit-scrollbar{display:none}
.slbl{font-size:11px;color:var(--text3);font-weight:600;white-space:nowrap;flex-shrink:0}
.sbtn{flex-shrink:0;background:none;border:1.5px solid var(--line);color:var(--text2);font-size:11px;font-weight:700;padding:5px 12px;border-radius:20px;cursor:pointer;white-space:nowrap;transition:all .15s}
.sbtn.on{border-color:var(--gold);color:var(--gold)}
/* LIST */
.list{padding:4px 12px 120px;display:flex;flex-direction:column;gap:10px}
.card{background:var(--card);border:1.5px solid var(--line);border-radius:var(--r);overflow:hidden;cursor:pointer;transition:transform .15s,border-color .15s}
.card:active{transform:scale(.985);border-color:var(--gold)}
.card-img{width:100%;aspect-ratio:16/10;object-fit:cover;display:block;background:var(--card2)}
.card-img-ph{width:100%;aspect-ratio:16/10;display:flex;align-items:center;justify-content:center;background:var(--card2);font-size:40px;color:var(--text3)}
.card-body{padding:13px 14px 14px}
.card-name{font-size:17px;font-weight:800;letter-spacing:-.4px;margin-bottom:8px}
/* PRICE ROW IN CARD */
.price-row{display:flex;gap:16px;align-items:flex-end;margin-bottom:10px}
.price-col{display:flex;flex-direction:column}
.price-col .lbl{font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:2px}
.price-col .val-auction{font-size:18px;font-weight:800;color:var(--gold);letter-spacing:-.3px}
.price-col .val-ua{font-size:22px;font-weight:900;color:var(--blue);letter-spacing:-.5px}
.price-divider{width:1px;height:36px;background:var(--line);flex-shrink:0}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.tag{background:var(--card2);border:1px solid var(--line);color:var(--text2);font-size:11px;font-weight:600;padding:3px 9px;border-radius:7px}
.tag.dmg{background:rgba(224,82,82,.08);border-color:rgba(224,82,82,.3);color:var(--red)}
.btn-order-card{width:100%;background:var(--gold);color:#000;font-size:14px;font-weight:900;border:none;padding:11px;border-radius:10px;cursor:pointer}
.btn-order-card:active{opacity:.8}
/* DETAIL */
.detail{position:fixed;inset:0;z-index:100;background:var(--bg);overflow-y:auto;overscroll-behavior:contain;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1)}
.detail.open{transform:translateY(0)}
.d-hdr{position:sticky;top:0;z-index:10;background:rgba(10,10,10,.96);backdrop-filter:blur(24px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;align-items:center;gap:12px}
.back{width:38px;height:38px;border-radius:50%;background:var(--card2);border:1.5px solid var(--line);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;flex-shrink:0}
.d-hdr-name{font-size:15px;font-weight:800;line-height:1.2}
.d-hdr-vin{font-size:11px;color:var(--text2);font-family:monospace}
.gal{background:#000;position:relative}
.gal-slides{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none}
.gal-slides::-webkit-scrollbar{display:none}
.gal-slide{flex-shrink:0;width:100%;scroll-snap-align:start;aspect-ratio:4/3}
.gal-slide img{width:100%;height:100%;object-fit:cover}
.gal-count{position:absolute;bottom:12px;right:14px;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);color:#fff;font-size:12px;font-weight:700;padding:4px 11px;border-radius:20px}
.gal-dots{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:5px}
.dot{width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,.35);transition:all .2s}
.dot.on{background:#fff;transform:scale(1.35)}
.d-body{padding:16px 16px 130px}
/* DETAIL PRICE BLOCK */
.d-price-block{background:var(--card);border:1.5px solid var(--line);border-radius:var(--r);padding:16px;margin-bottom:14px;display:flex;gap:0}
.d-price-col{flex:1;display:flex;flex-direction:column;align-items:center;padding:4px 8px}
.d-price-col .lbl{font-size:10px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.d-price-col .val-auction{font-size:22px;font-weight:800;color:var(--gold);letter-spacing:-.5px}
.d-price-col .val-ua{font-size:32px;font-weight:900;color:var(--blue);letter-spacing:-1px}
.d-price-divider{width:1px;background:var(--line);margin:0 4px}
.dmg-block{background:rgba(224,82,82,.07);border:1.5px solid rgba(224,82,82,.2);border-radius:12px;padding:12px 14px;margin-bottom:14px}
.dmg-ttl{font-size:11px;font-weight:800;color:var(--red);letter-spacing:.5px;margin-bottom:5px}
.dmg-txt{font-size:13px;color:var(--text);line-height:1.4}
.sec-ttl{font-size:11px;font-weight:800;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;margin:18px 0 10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.spec{background:var(--card);border:1.5px solid var(--line);border-radius:12px;padding:11px 13px}
.spec-lbl{font-size:10px;color:var(--text2);font-weight:600;margin-bottom:3px}
.spec-val{font-size:14px;font-weight:800;line-height:1.2}
.vin-block{background:var(--card);border:1.5px solid var(--line);border-radius:12px;padding:13px 14px;cursor:pointer;transition:border-color .15s}
.vin-block:active{border-color:var(--gold)}
.vin-hint{font-size:11px;color:var(--text2);margin-bottom:4px}
.vin-num{font-family:monospace;font-size:15px;font-weight:700;letter-spacing:1.5px}
/* ACTION BAR */
.abar{position:fixed;bottom:0;left:0;right:0;z-index:200;background:rgba(10,10,10,.97);backdrop-filter:blur(24px);border-top:1px solid var(--line);padding:12px 16px max(20px,env(safe-area-inset-bottom));display:none;gap:10px}
.btn-order{flex:1;background:var(--gold);color:#000;font-size:15px;font-weight:900;border:none;padding:15px;border-radius:13px;cursor:pointer}
.btn-order:active{opacity:.8}
.btn-sec{background:var(--card2);border:1.5px solid var(--line);color:var(--text);font-size:15px;font-weight:700;padding:15px 18px;border-radius:13px;cursor:pointer;white-space:nowrap}
.btn-sec:active{background:var(--card)}
.empty{text-align:center;padding:80px 20px;color:var(--text3)}
.empty-ic{font-size:52px;margin-bottom:14px}
.empty-tx{font-size:15px;font-weight:600}
.loading{text-align:center;padding:80px 20px;color:var(--text2);font-size:15px}
</style>
</head>
<body>

<div id="listView">
  <div class="hdr">
    <div class="hdr-top">
      <div class="brand">–ê–í–¢–û<em>–ë–û–¢</em></div>
      <div class="chip" id="countChip">...</div>
    </div>
    <div class="srch">
      <span class="srch-ic">üîç</span>
      <input id="srchInput" placeholder="–ú–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å, VIN‚Ä¶" type="search" autocomplete="off">
    </div>

    <div class="filters-panel">
      <!-- –°–ª–∞–π–¥–µ—Ä —Ü–µ–Ω—ã -->
      <div class="slider-wrap">
        <div class="slider-label">
          <span class="slider-title">üí∞ –¶—ñ–Ω–∞ –≤ –£–∫—Ä–∞—ó–Ω—ñ</span>
          <span class="slider-vals" id="priceVals">$0 ‚Äî $0</span>
        </div>
        <div class="range-wrap">
          <div class="range-track"></div>
          <div class="range-fill" id="priceFill"></div>
          <input type="range" id="priceMin" min="0" max="100" value="0">
          <input type="range" id="priceMax" min="0" max="100" value="100">
        </div>
      </div>

      <!-- –°–ª–∞–π–¥–µ—Ä –≥–æ–¥–∞ -->
      <div class="slider-wrap">
        <div class="slider-label">
          <span class="slider-title">üìÖ –†—ñ–∫ –≤–∏–ø—É—Å–∫—É</span>
          <span class="slider-vals" id="yearVals">2015 ‚Äî 2026</span>
        </div>
        <div class="range-wrap">
          <div class="range-track"></div>
          <div class="range-fill" id="yearFill"></div>
          <input type="range" id="yearMin" min="2015" max="2026" value="2015">
          <input type="range" id="yearMax" min="2015" max="2026" value="2026">
        </div>
      </div>

      <!-- –ú–∞—Ä–∫–∞ + –¢–∏–ø -->
      <div class="sel-row">
        <select class="fsel" id="makeSel"><option value="">–í—Å—ñ –º–∞—Ä–∫–∏</option></select>
        <select class="fsel" id="typeSel"><option value="">–í—Å—ñ —Ç–∏–ø–∏</option></select>
      </div>

      <!-- –ú–æ–¥–µ–ª—å (–ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞, —Å–∫—Ä—ã—Ç–∞ –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –º–∞—Ä–∫–∞) -->
      <div class="sel-row full" id="modelRow" style="display:none">
        <select class="fsel" id="modelSel"><option value="">–í—Å—ñ –º–æ–¥–µ–ª—ñ</option></select>
      </div>
    </div>
  </div>

  <div class="sortbar">
    <span class="slbl">–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è:</span>
    <button class="sbtn on" data-s="price-asc">–¶—ñ–Ω–∞ ‚Üë</button>
    <button class="sbtn" data-s="price-desc">–¶—ñ–Ω–∞ ‚Üì</button>
    <button class="sbtn" data-s="year-desc">–ù–æ–≤—ñ—à—ñ</button>
  </div>
  <div class="list" id="carList"><div class="loading">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
</div>

<div class="detail" id="detailView">
  <div class="d-hdr">
    <div class="back" id="backBtn">‚Üê</div>
    <div>
      <div class="d-hdr-name" id="dName"></div>
      <div class="d-hdr-vin" id="dVin"></div>
    </div>
  </div>
  <div class="gal" id="dGal"></div>
  <div class="d-body" id="dBody"></div>
</div>

<div class="abar" id="actionBar">
  <button class="btn-sec" id="btnShare">üì§ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å</button>
  <button class="btn-order" id="btnOrder">üöó –ó–∞–º–æ–≤–∏—Ç–∏ –∞–≤—Ç–æ</button>
</div>

<script>
const tg = window.Telegram?.WebApp;
if(tg){tg.expand();tg.ready();}

const ORDER_URL = 'https://t.me/cars24club_bot?start=699f5656fd7eb6c22c0d9a82';
const WORKER_URL = 'https://script.google.com/macros/s/AKfycbyMSUoWTvnE5n9rusu_AxY2N7zwQ6iT6LIhk0rH3TJ5Wt8u3D68DakXFXmvvZZMA7FC/exec';

let CARS=[], sort='price-asc', query='';
let fMake='', fModel='', fType='';
let fPriceMin=0, fPriceMax=Infinity, fYearMin=2015, fYearMax=2026;
let priceSteps=[], activeCar=null;

fetch('cars.json')
  .then(r=>r.json())
  .then(data=>{CARS=data;initFilters();render();})
  .catch(()=>{document.getElementById('carList').innerHTML='<div class="empty"><div class="empty-ic">‚ùå</div><div class="empty-tx">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div></div>';});

function initFilters(){
  // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–∞—Ä–∫–∏
  const makes=[...new Set(CARS.map(c=>c.make).filter(Boolean))].sort();
  const ms=document.getElementById('makeSel');
  makes.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;ms.appendChild(o);});

  // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–∏–ø—ã –∫—É–∑–æ–≤–∞
  const types=[...new Set(CARS.map(c=>c.body_type).filter(Boolean))].sort();
  const ts=document.getElementById('typeSel');
  types.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;ts.appendChild(o);});

  // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª–∞–π–¥–µ—Ä —Ü–µ–Ω—ã
  const prices=CARS.map(c=>c.price_ua||0).filter(p=>p>0).sort((a,b)=>a-b);
  // –°–æ–∑–¥–∞—ë–º ~20 —à–∞–≥–æ–≤
  const minP=Math.floor(prices[0]/500)*500;
  const maxP=Math.ceil(prices[prices.length-1]/500)*500;
  priceSteps=[];
  for(let p=minP;p<=maxP;p+=500) priceSteps.push(p);
  const pMin=document.getElementById('priceMin');
  const pMax=document.getElementById('priceMax');
  pMin.max=pMax.max=priceSteps.length-1;
  pMin.value=0; pMax.value=priceSteps.length-1;
  fPriceMin=priceSteps[0]; fPriceMax=priceSteps[priceSteps.length-1];
  updatePriceSlider();

  // –°–ª–∞–π–¥–µ—Ä –≥–æ–¥–∞
  const years=CARS.map(c=>c.year).filter(Boolean);
  const minY=Math.min(...years); const maxY=Math.max(...years);
  document.getElementById('yearMin').min=minY; document.getElementById('yearMin').max=maxY; document.getElementById('yearMin').value=minY;
  document.getElementById('yearMax').min=minY; document.getElementById('yearMax').max=maxY; document.getElementById('yearMax').value=maxY;
  fYearMin=minY; fYearMax=maxY;
  updateYearSlider();
}

function updatePriceSlider(){
  const pMin=document.getElementById('priceMin');
  const pMax=document.getElementById('priceMax');
  let lo=parseInt(pMin.value), hi=parseInt(pMax.value);
  if(lo>hi){const t=lo;lo=hi;hi=t;}
  fPriceMin=priceSteps[lo]||0;
  fPriceMax=priceSteps[hi]||Infinity;
  const pct1=lo/(priceSteps.length-1)*100;
  const pct2=hi/(priceSteps.length-1)*100;
  document.getElementById('priceFill').style.left=pct1+'%';
  document.getElementById('priceFill').style.width=(pct2-pct1)+'%';
  document.getElementById('priceVals').textContent=`$${fmt(fPriceMin)} ‚Äî $${fmt(fPriceMax)}`;
}

function updateYearSlider(){
  const yMin=document.getElementById('yearMin');
  const yMax=document.getElementById('yearMax');
  let lo=parseInt(yMin.value), hi=parseInt(yMax.value);
  if(lo>hi){const t=lo;lo=hi;hi=t;}
  fYearMin=lo; fYearMax=hi;
  const min=parseInt(yMin.min), max=parseInt(yMin.max);
  const pct1=(lo-min)/(max-min)*100;
  const pct2=(hi-min)/(max-min)*100;
  document.getElementById('yearFill').style.left=pct1+'%';
  document.getElementById('yearFill').style.width=(pct2-pct1)+'%';
  document.getElementById('yearVals').textContent=`${fYearMin} ‚Äî ${fYearMax}`;
}

document.getElementById('priceMin').addEventListener('input',()=>{updatePriceSlider();render();});
document.getElementById('priceMax').addEventListener('input',()=>{updatePriceSlider();render();});
document.getElementById('yearMin').addEventListener('input',()=>{updateYearSlider();render();});
document.getElementById('yearMax').addEventListener('input',()=>{updateYearSlider();render();});

document.getElementById('makeSel').addEventListener('change',function(){
  fMake=this.value; fModel=''; this.className='fsel'+(fMake?' active':'');
  // –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª–∏
  const modelRow=document.getElementById('modelRow');
  const modelSel=document.getElementById('modelSel');
  if(fMake){
    const models=[...new Set(CARS.filter(c=>c.make===fMake).map(c=>c.model).filter(Boolean))].sort();
    modelSel.innerHTML='<option value="">–í—Å—ñ –º–æ–¥–µ–ª—ñ</option>';
    models.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;modelSel.appendChild(o);});
    modelRow.style.display='';
  } else {
    modelRow.style.display='none';
  }
  render();
});

document.getElementById('modelSel').addEventListener('change',function(){
  fModel=this.value; this.className='fsel'+(fModel?' active':''); render();
});

document.getElementById('typeSel').addEventListener('change',function(){
  fType=this.value; this.className='fsel'+(fType?' active':''); render();
});

document.querySelectorAll('.sbtn').forEach(b=>{
  b.onclick=()=>{sort=b.dataset.s;document.querySelectorAll('.sbtn').forEach(x=>x.classList.remove('on'));b.classList.add('on');render();};
});
document.getElementById('srchInput').addEventListener('input',e=>{query=e.target.value.trim();render();});

function fmt(n){return n?Number(n).toLocaleString('uk-UA'):'‚Äî';}

function filtered(){
  let list=[...CARS];
  if(fMake)  list=list.filter(c=>c.make===fMake);
  if(fModel) list=list.filter(c=>c.model===fModel);
  if(fType)  list=list.filter(c=>c.body_type===fType);
  list=list.filter(c=>{
    const p=c.price_ua||0;
    return p>=fPriceMin && p<=fPriceMax;
  });
  list=list.filter(c=>(!c.year||(c.year>=fYearMin&&c.year<=fYearMax)));
  if(query){
    const q=query.toLowerCase();
    list=list.filter(c=>(c.make||'').toLowerCase().includes(q)||(c.model||'').toLowerCase().includes(q)||(c.vin||'').toLowerCase().includes(q)||String(c.year||'').includes(q));
  }
  list.sort((a,b)=>{
    if(sort==='price-asc')  return (a.price_ua||a.price||0)-(b.price_ua||b.price||0);
    if(sort==='price-desc') return (b.price_ua||b.price||0)-(a.price_ua||a.price||0);
    if(sort==='year-desc')  return (b.year||0)-(a.year||0);
    return 0;
  });
  return list;
}

function orderCar(e, vin, carName){
  e.stopPropagation();
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—à–∏–Ω–µ –≤ Google Apps Script ‚Üí Sendpulse
  const userId = tg?.initDataUnsafe?.user?.id;
  if(userId && carName){
    fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ telegram_id: userId, car_name: carName }),
    }).catch(()=>{});
  }
  if(tg){ tg.openLink(ORDER_URL); setTimeout(()=>tg.close(),300); }
  else window.open(ORDER_URL,'_blank');
}

function render(){
  const list=filtered();
  document.getElementById('countChip').textContent=list.length+' –∞–≤—Ç–æ';
  const el=document.getElementById('carList');
  if(!list.length){el.innerHTML='<div class="empty"><div class="empty-ic">üîç</div><div class="empty-tx">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div></div>';return;}
  el.innerHTML=list.map(c=>{
    const photo=c.photos&&c.photos[0]?`<img class="card-img" src="${c.photos[0]}" loading="lazy" alt="" onerror="this.parentElement.innerHTML='<div class=card-img-ph>üöó</div>'">`:`<div class="card-img-ph">üöó</div>`;
    const mi=c.mileage?`${fmt(c.mileage)} mi`:'';
    const eng=c.engine?`${c.engine}L`:'';
    const tags=[mi,eng,c.transmission].filter(Boolean);
    const dmg=c.damage?c.damage.replace(/^–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ /i,''):'';
    return `<div class="card" onclick="openCar('${c.vin}')">
      ${photo}
      <div class="card-body">
        <div class="card-name">${c.year||''} ${c.make||''} ${c.model||''}</div>
        <div class="price-row">
          <div class="price-col">
            <span class="lbl">üá∫üá∏ –ê—É–∫—Ü—ñ–æ–Ω</span>
            <span class="val-auction">$${fmt(c.price)}</span>
          </div>
          ${c.price_ua?`<div class="price-divider"></div>
          <div class="price-col">
            <span class="lbl">üá∫üá¶ –í –£–∫—Ä–∞—ó–Ω—ñ</span>
            <span class="val-ua">$${fmt(c.price_ua)}</span>
          </div>`:''}
        </div>
        <div class="tags">
          ${tags.map(t=>`<span class="tag">${t}</span>`).join('')}
          ${dmg?`<span class="tag dmg">‚ö† ${dmg}</span>`:''}
        </div>
        <button class="btn-order-card" onclick="orderCar(event,'${c.vin}','${c.year} ${c.make} ${c.model}')">üöó –ó–∞–º–æ–≤–∏—Ç–∏ –∞–≤—Ç–æ</button>
      </div>
    </div>`;
  }).join('');
}

function openCar(vin){
  activeCar=CARS.find(c=>c.vin===vin);
  if(!activeCar) return;
  const c=activeCar;
  document.getElementById('dName').textContent=`${c.year||''} ${c.make||''} ${c.model||''}`;
  document.getElementById('dVin').textContent=c.vin;
  const gal=document.getElementById('dGal');
  if(c.photos&&c.photos.length){
    gal.innerHTML=`<div class="gal-slides" id="galSlides">${c.photos.map(p=>`<div class="gal-slide"><img src="${p}" loading="lazy" alt=""></div>`).join('')}</div><div class="gal-count"><span id="galIdx">1</span>/${c.photos.length}</div><div class="gal-dots">${c.photos.map((_,i)=>`<div class="dot${i===0?' on':''}" id="gd${i}"></div>`).join('')}</div>`;
    document.getElementById('galSlides').addEventListener('scroll',function(){
      const i=Math.round(this.scrollLeft/this.offsetWidth);
      document.getElementById('galIdx').textContent=i+1;
      c.photos.forEach((_,j)=>{const d=document.getElementById('gd'+j);if(d)d.className='dot'+(j===i?' on':'');});
    },{passive:true});
  } else {
    gal.innerHTML=`<div class="card-img-ph" style="aspect-ratio:4/3">üöó</div>`;
  }
  const specs=[
    ['–†—ñ–∫',c.year],['–ö—É–∑–æ–≤',c.body_type],
    ['–ü—Ä–æ–±—ñ–≥',c.mileage?fmt(c.mileage)+' mi':null],
    ['–î–≤–∏–≥—É–Ω',c.engine?c.engine+'L':null],
    ['–ü–∞–ª—å–Ω–µ',c.fuel],['–ö–ü–ü',c.transmission],['–ü—Ä–∏–≤—ñ–¥',c.drive],
  ].filter(([,v])=>v);
  document.getElementById('dBody').innerHTML=`
    <div class="d-price-block">
      <div class="d-price-col">
        <span class="lbl">üá∫üá∏ –ê—É–∫—Ü—ñ–æ–Ω</span>
        <span class="val-auction">$${fmt(c.price)}</span>
      </div>
      ${c.price_ua?`<div class="d-price-divider"></div>
      <div class="d-price-col">
        <span class="lbl">üá∫üá¶ –í –£–∫—Ä–∞—ó–Ω—ñ</span>
        <span class="val-ua">$${fmt(c.price_ua)}</span>
      </div>`:''}
    </div>
    ${c.damage?`<div class="dmg-block"><div class="dmg-ttl">‚ö† –ü–û–®–ö–û–î–ñ–ï–ù–ù–Ø</div><div class="dmg-txt">${c.damage}</div></div>`:''}
    <div class="sec-ttl">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
    <div class="grid">${specs.map(([l,v2])=>`<div class="spec"><div class="spec-lbl">${l}</div><div class="spec-val">${v2}</div></div>`).join('')}</div>
    <div class="sec-ttl">VIN-–∫–æ–¥</div>
    <div class="vin-block" onclick="copyVin('${c.vin}')">
      <div class="vin-hint">üìã –ù–∞—Ç–∏—Å–Ω–∏ –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è</div>
      <div class="vin-num">${c.vin}</div>
    </div>`;
  document.getElementById('detailView').classList.add('open');
  document.getElementById('actionBar').style.display='flex';
  if(tg?.BackButton){tg.BackButton.show();tg.BackButton.onClick(closeCar);}
}

function closeCar(){
  document.getElementById('detailView').classList.remove('open');
  document.getElementById('actionBar').style.display='none';
  activeCar=null;
  if(tg?.BackButton) tg.BackButton.hide();
}
function copyVin(v){
  navigator.clipboard?.writeText(v).then(()=>{if(tg)tg.showAlert('VIN —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ:\n'+v);else alert('VIN: '+v);});
}
document.getElementById('backBtn').onclick=closeCar;
document.getElementById('btnOrder').onclick=()=>{
  if(activeCar){
    const userId = tg?.initDataUnsafe?.user?.id;
    const carName = `${activeCar.year} ${activeCar.make} ${activeCar.model}`;
    if(userId){
      fetch(WORKER_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ telegram_id: userId, car_name: carName }),
      }).catch(()=>{});
    }
  }
  if(tg){ tg.openLink(ORDER_URL); setTimeout(()=>tg.close(),300); }
  else window.open(ORDER_URL,'_blank');
};
document.getElementById('btnShare').onclick=()=>{
  if(!activeCar) return;
  const c=activeCar;
  const txt=`${c.year} ${c.make} ${c.model} ‚Äî $${fmt(c.price)}\nVIN: ${c.vin}`;
  if(tg) tg.switchInlineQuery(txt);
  else navigator.clipboard?.writeText(txt);
};
</script>
</body>
</html>